# Image Tagging & Versioning Guide

## Image Tagging Strategy

The consolidated deployment workflow uses a **simple, clean versioning strategy**:

- **Image names**: No environment suffix, just simple names (`enclave`, `host`, etc.)
- **Image tag**: Git tag (e.g., `v1.5.8.0`) OR commit hash (e.g., `abc123def`)
- **Image registry**: Single registry `testnetobscuronet.azurecr.io/obscuronet`

---

## Image Names Built

All images are tagged with the same version:

| Image | Repository | Examples |
|-------|-----------|----------|
| Enclave | `testnetobscuronet.azurecr.io/obscuronet/enclave` | `v1.5.8.0`, `abc123def` |
| Host | `testnetobscuronet.azurecr.io/obscuronet/host` | `v1.5.8.0`, `abc123def` |
| L1 Challenge Period | `testnetobscuronet.azurecr.io/obscuronet/l1challengeperiod` | `v1.5.8.0`, `abc123def` |
| L1 Contract Deployer | `testnetobscuronet.azurecr.io/obscuronet/l1contractdeployer` | `v1.5.8.0`, `abc123def` |
| L1 Grant Sequencers | `testnetobscuronet.azurecr.io/obscuronet/l1grantsequencers` | `v1.5.8.0`, `abc123def` |
| L2 Contract Deployer | `testnetobscuronet.azurecr.io/obscuronet/l2contractdeployer` | `v1.5.8.0`, `abc123def` |

---

## How Image Tag is Determined

```
Priority 1: User input (image_tag parameter)
├─ If specified: Use exactly as provided
│  Example: User enters "v1.5.8.0" → Use "v1.5.8.0"
│
Priority 2: Git tag (on exact commit)
├─ If current commit is tagged: Use git tag
│  Example: Commit tagged as "v1.5.8.0" → Use "v1.5.8.0"
│
Priority 3: Commit hash
└─ If no tag on commit: Use short commit hash
   Example: Commit hash "abc123def456" → Use "abc123def" (short)
```

### Example Scenarios

**Scenario 1: Release from git tag**
```bash
# Commit tagged as v1.5.8.0
git tag v1.5.8.0
git push origin v1.5.8.0

# Run deployment
image_tag: (leave blank)

# Result:
# Images built as: v1.5.8.0
# testnetobscuronet.azurecr.io/obscuronet/enclave:v1.5.8.0
# testnetobscuronet.azurecr.io/obscuronet/host:v1.5.8.0
```

**Scenario 2: Build from dev commit (no tag)**
```bash
# On main branch, commit abc123def
# No git tag on this commit

# Run deployment
image_tag: (leave blank)

# Result:
# Images built as: abc123def (short commit hash)
# testnetobscuronet.azurecr.io/obscuronet/enclave:abc123def
# testnetobscuronet.azurecr.io/obscuronet/host:abc123def
```

**Scenario 3: Manual override**
```bash
# Want to rebuild specific version

# Run deployment
image_tag: v1.5.7.0

# Result:
# Images built as: v1.5.7.0 (exact input)
# testnetobscuronet.azurecr.io/obscuronet/enclave:v1.5.7.0
# testnetobscuronet.azurecr.io/obscuronet/host:v1.5.7.0
```

---

## Ten-Apps YAML Updates

When you deploy with new images, the workflow automatically updates **all** `values-*.yaml` files:

### Before Deployment
```yaml
# values-dev-sequencer.yaml
enclave:
  image:
    repository: testnetobscuronet.azurecr.io/obscuronet/enclave
    tag: "v1.5.7.0"

enclave02:
  image:
    repository: testnetobscuronet.azurecr.io/obscuronet/enclave
    tag: "v1.5.7.0"

host:
  image:
    repository: testnetobscuronet.azurecr.io/obscuronet/host
    tag: "v1.5.7.0"
```

### After Deployment (with `image_tag: v1.5.8.0`)
```yaml
# values-dev-sequencer.yaml
enclave:
  image:
    repository: testnetobscuronet.azurecr.io/obscuronet/enclave
    tag: "v1.5.8.0"

enclave02:
  image:
    repository: testnetobscuronet.azurecr.io/obscuronet/enclave
    tag: "v1.5.8.0"

host:
  image:
    repository: testnetobscuronet.azurecr.io/obscuronet/host
    tag: "v1.5.8.0"
```

**Updated files in ten-apps:**
- `nonprod-argocd-config/apps/envs/dev/valuesFile/values-dev-*.yaml`
- `nonprod-argocd-config/apps/envs/uat/valuesFile/values-uat-*.yaml`
- `nonprod-argocd-config/apps/envs/sepolia/valuesFile/values-sepolia-*.yaml`
- `prod-argocd-config/apps/envs/mainnet/valuesFile/values-mainnet-*.yaml`

---

## Git Commit Message

After updating ten-apps, a git commit is automatically created:

```
commit abc123xyz (auto-generated by workflow)
Author: GitHub Actions <actions@github.com>

chore: update image tags to v1.5.8.0 for dev

- Updated all enclave, host image tags
- ArgoCD will pull new images on sync
```

---

## Workflow Decisions

### Non-Destructive Deployment
- ✅ Builds new images (if `image_build: yes`)
- ✅ Updates ten-apps YAML with new tag
- ✅ Commits changes to ten-apps
- ✅ ArgoCD syncs incrementally
- ❌ Does NOT restart L2 services
- ❌ Node selectors NOT updated

**Use case:** Regular image updates, no network reset needed

### Destructive Deployment
- ✅ Builds new images (if `image_build: yes`)
- ✅ Updates ten-apps YAML with new tag
- ✅ Updates node selectors (if provided)
- ✅ Commits changes to ten-apps
- ✅ Deletes and recreates all pods
- ✅ Deploys L2 contracts
- ✅ Full network reset

**Use case:** Major upgrades, network maintenance, full reset

---

## Image Build Process

### What Gets Built

```bash
# For each Dockerfile:
DOCKER_BUILDKIT=1 docker build \
  -t testnetobscuronet.azurecr.io/obscuronet/<IMAGE>:<TAG> \
  --build-arg AZURE_TENANT_ID=<secret> \
  --build-arg AZURE_SUBSCRIPTION_ID=<secret> \
  -f dockerfiles/<DOCKERFILE> .

docker push testnetobscuronet.azurecr.io/obscuronet/<IMAGE>:<TAG>
```

### Build Time Estimates

| Image | Time |
|-------|------|
| enclave | 8-10 min |
| host | 3-5 min |
| l1challengeperiod | 2-3 min |
| l1contractdeployer | 2-3 min |
| l1grantsequencers | 2-3 min |
| l2contractdeployer | 2-3 min |
| **Total** | **~20-30 min** |

---

## Best Practices

### ✅ Do

1. **Use git tags for releases**
   ```bash
   git tag v1.5.8.0
   git push origin v1.5.8.0
   # Then run deployment with image_tag: (blank)
   ```

2. **Use commit hash for dev builds**
   - Leave `image_tag` blank
   - Workflow auto-detects commit hash
   - Useful for testing before release

3. **Explicit tag for rebuilds**
   ```
   image_tag: v1.5.7.0
   # Rebuilds specific version if needed
   ```

4. **Check workflow logs**
   - Verify image was built successfully
   - Confirm ten-apps was updated
   - Check git commit message

### ❌ Don't

1. **Don't use `latest` tag**
   - Can't reproduce builds
   - Hard to debug issues
   - Loss of audit trail

2. **Don't mix commit hashes and tags**
   - Be consistent: either all tags or all hashes
   - Document your versioning strategy

3. **Don't manually push images**
   - Let workflow do it
   - Ensures ten-apps is updated
   - Maintains audit trail

4. **Don't forget to push tags**
   ```bash
   git tag v1.5.8.0
   git push origin v1.5.8.0  # Must push tag!
   ```

---

## Troubleshooting

### Issue: Image not found in registry

**Symptoms:**
- `docker pull testnetobscuronet.azurecr.io/obscuronet/enclave:v1.5.8.0` fails
- ArgoCD shows image pull error

**Solutions:**
```bash
# 1. List available tags
az acr repository show-tags \
  --name testnetobscuronet \
  --repository obscuronet/enclave

# 2. Check if image was built
# Search workflow logs for "✅ Pushed"

# 3. Verify image_tag parameter
# Was it spelled correctly?

# 4. Re-run build
# deployment: image_build: yes
# image_tag: v1.5.8.0
```

### Issue: Ten-apps not updated

**Symptoms:**
- Workflow succeeded but ten-apps has no new commit
- Old image tags still in YAML

**Solutions:**
```bash
# 1. Check if DEPLOY_ACTIONS_PAT is valid
# Does PAT have write access to ten-apps?

# 2. Check workflow logs
# Search for "Updated and pushed changes to ten-apps"

# 3. Verify git config
# Does ten-apps checkout have correct credentials?

# 4. Manual update (last resort)
cd ten-apps
yq eval -i '.enclave.image.tag = "v1.5.8.0"' \
  nonprod-argocd-config/apps/envs/dev/valuesFile/values-dev-sequencer.yaml
git add .
git commit -m "chore: update image tags to v1.5.8.0 for dev"
git push
```

### Issue: Commit hash too short

**Symptoms:**
- Image tag looks like `abc123` (too short)
- Multiple images with same short hash

**Solution:**
- Specify full hash explicitly: `image_tag: abc123def456`
- Or use git tag for clarity: `git tag v1.5.8.0`

---

## Registry View

To see all built images:

```bash
# List enclave images
az acr repository show-tags \
  --name testnetobscuronet \
  --repository obscuronet/enclave

# List host images
az acr repository show-tags \
  --name testnetobscuronet \
  --repository obscuronet/host

# Pull specific image
docker pull testnetobscuronet.azurecr.io/obscuronet/enclave:v1.5.8.0
```

---

## Example: Complete Release Flow

```bash
# 1. On main branch
git checkout main
git pull origin main

# 2. Make your changes
# ... edit files ...

# 3. Commit changes
git add .
git commit -m "feat: add new feature"
git push origin main

# 4. Create git tag
git tag v1.5.8.0
git push origin v1.5.8.0

# 5. Run deployment workflow
# Go to GitHub Actions
# Select: "k8s Deploy Consolidated"
#
# Inputs:
#   testnet_type: dev-testnet
#   deployment_strategy: destructive
#   image_build: yes
#   image_tag: (leave blank - auto-detect v1.5.8.0)
#   confirmation: (leave blank - dev doesn't need approval)
#
# Click "Run workflow"

# 6. Monitor
# Workflow builds images as: v1.5.8.0
# Pushes to: testnetobscuronet.azurecr.io/obscuronet/enclave:v1.5.8.0
# Updates ten-apps
# Commits: "chore: update image tags to v1.5.8.0 for dev"
# Deploys to dev environment

# 7. After testing on dev, promote to uat
# Inputs:
#   testnet_type: uat-testnet
#   deployment_strategy: non-destructive
#   image_build: no
#   image_tag: v1.5.8.0
#
# Result: uat pulled and deployed v1.5.8.0

# 8. After UAT approval, deploy to sepolia (requires approval)
# Inputs:
#   testnet_type: sepolia-testnet
#   deployment_strategy: destructive
#   image_build: no
#   image_tag: v1.5.8.0
#   confirmation: confirm
#
# Result: Workflow pauses for approval, then deploys

# 9. After sepolia verification, deploy to mainnet (requires approval)
# Inputs:
#   testnet_type: mainnet
#   deployment_strategy: destructive
#   image_build: no
#   image_tag: v1.5.8.0
#   confirmation: confirm
#
# Result: Workflow pauses for approval, then deploys to production
```

---

## Image Layering

All images are built from Dockerfile and go source:

```
Dockerfile (e.g., enclave.Dockerfile)
    ↓
Docker build (with AZURE credentials)
    ↓
Tag: testnetobscuronet.azurecr.io/obscuronet/enclave:v1.5.8.0
    ↓
Push to registry
    ↓
Workflow updates ten-apps YAML
    ↓
ArgoCD pulls image on sync
    ↓
Kubernetes creates pods with new image
```

---

## Support

For questions or issues:
1. Check this guide first
2. Review workflow logs in GitHub Actions
3. Verify git tags exist: `git tag -l`
4. Check registry: `az acr repository show-tags ...`
5. Contact DevOps team with workflow run number
