# Run script to retrieve funds from an existing testnet deployment

name: '[M] Recover Testnet Funds'
run-name: '[M] Recover Testnet Funds ( ${{ github.event.inputs.testnet_type }} )'
on:
  workflow_dispatch:
    inputs:
      testnet_type:
        description: 'Testnet Type'
        required: true
        default: 'dev-testnet'
        type: choice
        options:
          - 'dev-testnet'
          - 'uat-testnet'
          - 'sepolia-testnet'
          - 'mainnet'
jobs:
  recover-network-funds:
    runs-on: ubuntu-latest
    environment:
      name: ${{ github.event.inputs.testnet_type }}
    steps:
      - name: 'Print GitHub variables'
        # This is a useful record of what the environment variables were at the time the job ran, for debugging and reference
        run: |
          echo "GitHub Variables = ${{ toJSON(vars) }}"

      - uses: actions/checkout@v4

      - name: 'Login to Azure docker registry'
        uses: azure/docker-login@v1
        with:
          login-server: testnetobscuronet.azurecr.io
          username: testnetobscuronet
          password: ${{ secrets.REGISTRY_PASSWORD }}

      - name: 'Build and push docker image'
        run: |
          DOCKER_BUILDKIT=1 docker build -t ${{ vars.L2_HARDHATDEPLOYER_DOCKER_BUILD_TAG }} -f tools/hardhatdeployer/Dockerfile .
          docker push ${{ vars.L2_HARDHATDEPLOYER_DOCKER_BUILD_TAG }}

      -  name: Parse l1-config.yaml
         id: parse
         env:
           TESTNET_SHORT_NAME: ${{ steps.prepareTestnetShortName.outputs.TESTNET_SHORT_NAME }}
         run: |
           CFG=cfg/nonprod-argocd-config/apps/envs/$TESTNET_SHORT_NAME/valuesFile/l1-values.yaml
           
           echo "network_config=$(yq -r '.l1Config.networkConfig'     "$CFG")"   >> $GITHUB_OUTPUT

      - name: 'Run the funds recovery'
        id: runFundsRecovery
        shell: bash
        run: |
          DOCKER_API_VERSION=1.45 go run ./testnet/launcher/fundsrecovery/cmd \
          -l1_http_url=${{ secrets.L1_HTTP_URL }} \
          -private_key=${{ secrets.ACCOUNT_PK_WORKER }} \
          -docker_image=${{ vars.L2_HARDHATDEPLOYER_DOCKER_BUILD_TAG }} \
          -network_config_addr="${{ steps.parse.outputs.network_config }}" 

      - name: 'Save container logs on failure'
        if: ${{ always() }}
        run: |
          docker logs `docker ps -aqf "name=recover-funds"` > recover-funds.out 2>&1

      - name: 'Upload container logs on failure'
        uses: actions/upload-artifact@v4
        if: ${{ always() }}
        with:
          name: recover-funds
          path: |
            recover-funds.out
          retention-days: 2
